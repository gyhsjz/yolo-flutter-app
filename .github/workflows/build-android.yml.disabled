# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

# Android Build & Deploy CI/CD

name: Build Android

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: gradle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Verify Flutter installation
        run: flutter doctor -v

      - name: Build APK (Release)
        run: flutter build apk --release
        working-directory: ./example

      - name: Build App Bundle (Release)
        run: flutter build appbundle --release
        working-directory: ./example

      - name: Rename APK
        run: |
          mv example/build/app/outputs/flutter-apk/app-release.apk \
             example/build/app/outputs/flutter-apk/yolo-flutter-${{ github.sha }}.apk

      - name: Rename App Bundle
        run: |
          mv example/build/app/outputs/bundle/release/app-release.aab \
             example/build/app/outputs/bundle/release/yolo-flutter-${{ github.sha }}.aab

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: yolo-flutter-apk
          path: example/build/app/outputs/flutter-apk/yolo-flutter-${{ github.sha }}.apk
          retention-days: 30

      - name: Upload App Bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: yolo-flutter-aab
          path: example/build/app/outputs/bundle/release/yolo-flutter-${{ github.sha }}.aab
          retention-days: 30

      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            example/build/app/outputs/flutter-apk/yolo-flutter-${{ github.sha }}.apk
            example/build/app/outputs/bundle/release/yolo-flutter-${{ github.sha }}.aab
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment PR with download link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Android æ„å»ºæˆåŠŸ\n\n` +
                    `**APK ä¸‹è½½**: [ç‚¹å‡»ä¸‹è½½](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n` +
                    `**æäº¤**: ${{ github.sha }}\n` +
                    `**åˆ†æ”¯**: ${{ github.ref_name }}`
            })